name: Convert DOCX to Markdown

on:
  push:
    paths:
      - "docs/docx/**/*.docx"
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Create output directory
        run: mkdir -p docs/md

      - name: Convert DOCX to Markdown
        id: convert
        run: |
          echo "Searching for DOCX files in docs/docx/"
          files=$(find docs/docx -type f -name "*.docx")
          echo "Found files: $files"
          # For this example, process one file (you can extend for multiple)
          file=$(echo $files | awk '{print $1}')
          echo "Processing $file"
          filename=$(basename "$file" .docx)
          pandoc "$file" -f docx -t markdown --wrap=none -o docs/md/"$filename".md
          echo "Converted $file to docs/md/$filename.md"
          echo "::set-output name=mdfile::docs/md/$filename.md"

      - name: Update TOC
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          NEW_FILE: ${{ steps.convert.outputs.mdfile }}
        run: |
          echo "Updating TOC with commit message: $COMMIT_MESSAGE and file: $NEW_FILE"
          node .github/scripts/update-toc.js

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          add: "docs/md/*.md docs/_toc.yml"
          message: "Convert DOCX files to Markdown and update TOC"
